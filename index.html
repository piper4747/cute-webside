<html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>草原世界</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

    <style>
     <script>
    document.addEventListener('DOMContentLoaded', () => {
        console.log("--- 调试开始：脚本已加载 ---");

        AV.init({
            appId: "ERP3gC0G0Pdrnor7rSpDDIVT-gzGzoHsz",
            appKey: "Gj5IaBMkgKj0uQ4RvejArDXu",
            serverURL: "https://erp3gc0g.lc-cn-n1-shared.com"
        });
        console.log("1. LeanCloud SDK 初始化完毕。");

        // --- 全局元素获取 ---
        const authContainer = document.getElementById('auth-container'), userInfoContainer = document.getElementById('user-info-container'), greetingSpan = document.querySelector('.user-info .greeting'), logoutBtn = document.getElementById('logout-btn'), registerForm = document.getElementById('register-form'), loginForm = document.getElementById('login-form'), specialEventSection = document.getElementById('special-event-section'), eventConfirmBtn = document.getElementById('event-confirm-btn'), eventDeclineBtn = document.getElementById('event-decline-btn'), commentInput = document.getElementById('comment-input'), postButton = document.getElementById('post-comment-btn'), commentList = document.getElementById('comment-list'), backpackBtn = document.getElementById('backpack-btn'), backpackModal = document.getElementById('backpack-modal'), backpackList = document.getElementById('backpack-list'), redeemModal = document.getElementById('redeem-modal'), dateSelectionContainer = document.getElementById('date-selection-container'), finalConfirmBtn = document.getElementById('final-confirm-btn'), lotteryConfirmBtn = document.getElementById('lottery-confirm-btn'), lotteryDeclineBtn = document.getElementById('lottery-decline-btn'), lotteryWheelModal = document.getElementById('lottery-wheel-modal'), spinBtn = document.getElementById('spin-btn'), lotteryWheel = document.getElementById('lottery-wheel'), prizeModal = document.getElementById('prize-modal'), registerBtn = document.getElementById('register-btn'), loginBtn = document.getElementById('login-btn'), lotteryPromptModal = document.getElementById('lottery-prompt-modal');
        let selectedDate = null;
        console.log("2. 全局变量声明完毕。");

        // --- 弹窗通用逻辑 ---
        const openModal = (modal) => { if(modal) modal.style.display = 'block'; };
        const closeModal = (modal) => { if(modal) modal.style.display = 'none'; };
        const allModals = document.querySelectorAll('.modal-overlay');
        const allCloseBtns = document.querySelectorAll('.modal-close-btn');
        registerBtn.addEventListener('click', () => openModal(document.getElementById('register-modal')));
        loginBtn.addEventListener('click', () => openModal(document.getElementById('login-modal')));
        allCloseBtns.forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal-overlay').style.display = 'none' ));
        window.addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) closeModal(e.target); });
        console.log("3. 弹窗通用逻辑和监听器设置完毕。");

        // --- 核心功能函数 ---
        const updateNavUI = (user) => { if (user) { authContainer.style.display = 'none'; userInfoContainer.style.display = 'flex'; greetingSpan.textContent = `你好, ${user.get('username')}`; } else { authContainer.style.display = 'flex'; userInfoContainer.style.display = 'none'; } };
        const formatTime = (date) => { const now = new Date(); const diff = now - date; const minutes = Math.floor(diff / 60000); if (minutes < 1) return '刚刚'; if (minutes < 60) return `${minutes}分钟前`; const hours = Math.floor(minutes / 60); if (hours < 24) return `${hours}小时前`; return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`; };
        const loadComments = () => { commentList.innerHTML = '<p>正在加载评论...</p>'; const query = new AV.Query('Comment'); query.descending('createdAt'); query.find().then((comments) => { commentList.innerHTML = ''; if (comments.length === 0) { commentList.innerHTML = '<p>还没有人留下足迹哦~</p>'; return; } comments.forEach((c) => { const div = document.createElement('div'); div.className = 'comment'; div.innerHTML = `<img src="${c.get('authorAvatar') || 'https://i.pravatar.cc/150?u=guest'}" class="comment-avatar"><div class="comment-content"><div class="comment-header"><span class="comment-author">${c.get('authorName')}</span><span class="comment-time">${formatTime(c.createdAt)}</span></div><p class="comment-text">${c.get('content')}</p></div>`; commentList.appendChild(div); }); }).catch(error => { commentList.innerHTML = '<p>评论加载失败...</p>'; }); };
        const calculateAndShowBirthdayEvent = (user) => { const b = user.get('birthday'); if (!b) return; const t = new Date(); t.setHours(0, 0, 0, 0); const bM = b.getMonth(), bD = b.getDate(); let nB = new Date(t.getFullYear(), bM, bD); if (nB < t) { nB.setFullYear(t.getFullYear() + 1); } const dD = Math.ceil((nB - t) / 864e5); document.getElementById('event-username').textContent = user.get('username'); document.getElementById('birthday-countdown').textContent = dD; specialEventSection.style.display = 'flex'; };
        console.log("4. 核心功能函数定义完毕。");

        const initializePage = () => {
            const currentUser = AV.User.current();
            updateNavUI(currentUser);
            loadComments();
            if (currentUser) {
                currentUser.fetch().then(latestUser => {
                    updateNavUI(latestUser);
                    const hasSpun = latestUser.get('hasSpunLottery');
                    if (hasSpun) {
                        specialEventSection.style.display = 'none';
                    } else {
                        calculateAndShowBirthdayEvent(latestUser);
                    }
                }).catch(error => {
                    console.error("获取最新用户信息失败:", error);
                    specialEventSection.style.display = 'none';
                });
            }
        };
        console.log("5. initializePage 函数定义完毕。");

        // --- 事件监听器 ---
        registerForm.addEventListener('submit', (e) => {
            console.log("--- 调试信息：注册按钮被点击！ ---");
            e.preventDefault();
            const u = document.getElementById('reg-username').value.trim();
            const p = document.getElementById('reg-password').value.trim();
            const a = document.getElementById('reg-avatar').value.trim();
            if (!u || !p || !a) {
                alert('所有信息均为必填项！');
                return;
            }
            const y = document.getElementById('reg-birth-year').value;
            const m = document.getElementById('reg-birth-month').value;
            const d = document.getElementById('reg-birth-day').value;
            const b = new Date(y, m - 1, d);

            const user = new AV.User();
            user.setUsername(u);
            user.setPassword(p);
            user.set('birthday', b);
            user.set('avatar', a);

            const acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setWriteAccess(user, true);
            acl.setReadAccess(user, true); 

            user.setACL(acl);

            user.signUp().then(() => {
                alert('注册成功!');
                location.reload();
            }, (err) => {
                alert('注册失败: ' + err.message);
                console.error('注册失败，LeanCloud错误:', err);
            });
        });
        console.log("6. 注册表单(registerForm)的监听器已附加。");

        loginForm.addEventListener('submit', (e) => { e.preventDefault(); const u = document.getElementById('login-username').value, p = document.getElementById('login-password').value; AV.User.logIn(u, p).then(() => { alert('登录成功!'); location.reload(); }, (err) => alert('登录失败: ' + err.message)); });
        console.log("7. 登录表单(loginForm)的监听器已附加。");

        logoutBtn.addEventListener('click', () => { AV.User.logOut(); alert('已退出登录。'); location.reload(); });
        postButton.addEventListener('click', () => { const user = AV.User.current(); if (!user) { alert('请先登录再发表评论哦！'); return; } const text = commentInput.value; if (!text.trim()) { alert('评论内容不能为空哦！'); return; } const Comment = AV.Object.extend('Comment'); const c = new Comment(); c.set('content', text); c.set('authorName', user.get('username')); c.set('authorAvatar', user.get('avatar')); c.save().then(() => { commentInput.value = ''; loadComments(); }); });
        eventConfirmBtn.addEventListener('click', () => { specialEventSection.style.display = 'none'; openModal(lotteryPromptModal); });
        eventDeclineBtn.addEventListener('click', () => { if(confirm('真的要错过草原伙伴们的好意吗？')){ specialEventSection.style.display = 'none'; }});
        lotteryConfirmBtn.addEventListener('click', () => { closeModal(lotteryPromptModal); openModal(lotteryWheelModal); });
        lotteryDeclineBtn.addEventListener('click', () => closeModal(lotteryPromptModal));
        spinBtn.addEventListener('click', () => { const user = AV.User.current(); if (!user) return; spinBtn.disabled = true; const angle = (360 * 5) - 18; lotteryWheel.style.transform = `rotate(${angle}deg)`; setTimeout(() => { user.set('hasSpunLottery', true); user.addUnique('backpackItems', '神秘大奖'); user.save().then((savedUser) => { document.getElementById('prize-name').textContent = '神秘大奖'; closeModal(lotteryWheelModal); openModal(prizeModal); }).catch(err => { alert('保存抽奖结果失败，请重试'); console.error("保存用户抽奖状态失败:", err); spinBtn.disabled = false; }); }, 5500); });
        backpackBtn.addEventListener('click', () => { const user = AV.User.current(); if (!user) { alert('请先登录哦！'); return; } user.fetch().then(latestUser => { const items = latestUser.get('backpackItems') || []; const chosenDay = latestUser.get('day'); backpackList.innerHTML = ''; if (items.length === 0) { backpackList.innerHTML = '<p>你的背包空空如也~</p>'; } else { items.forEach(itemName => { const itemDiv = document.createElement('div'); itemDiv.className = 'backpack-item'; if (itemName === '神秘大奖' && chosenDay) { itemDiv.innerHTML = `<div class="backpack-item-header"><span class="backpack-item-name">【Mystery Day】</span></div><div class="backpack-item-details"><h4>如何使用：</h4><p>请在该日期当天早晨7点准时到达【西土城】地铁站，享受【Mystery Day】！</p><h4>我需要提前准备什么：</h4><p>请您凭感觉准备【Mystery Day】需要带的东西，活动将在夜晚结束，请您自行评估。</p><p><strong>您选择的日期是：${chosenDay}</strong></p></div>`; } else if (itemName === '神秘大奖') { itemDiv.innerHTML = `<div class="backpack-item-header"><span class="backpack-item-name">${itemName}</span><button class="btn btn-primary redeem-btn">兑换</button></div>`; itemDiv.querySelector('.redeem-btn').onclick = () => { closeModal(backpackModal); openModal(redeemModal); }; } else { itemDiv.innerHTML = `<span class="backpack-item-name">${itemName}</span>`; } backpackList.appendChild(itemDiv); }); } openModal(backpackModal); }); });
        dateSelectionContainer.addEventListener('click', (e) => { if (e.target.tagName === 'BUTTON') { dateSelectionContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); selectedDate = e.target.dataset.day; } });
        finalConfirmBtn.addEventListener('click', () => { if (!selectedDate) { alert('请先选择一个日期哦！'); return; } const user = AV.User.current(); if (!user) return; user.set('day', selectedDate); user.save().then(() => { alert(`选择成功！您的【Mystery Day】是 ${selectedDate}，请准时赴约！`); closeModal(redeemModal); }); });
        console.log("8. 其余所有监听器已附加。");

        // --- 初始化函数 ---
        const populateBirthdaySelects = () => { const y = document.getElementById('reg-birth-year'), m = document.getElementById('reg-birth-month'), d = document.getElementById('reg-birth-day'), cY = new Date().getFullYear(); for (let i = cY; i >= 1950; i--) { const o=document.createElement('option'); o.value=i; o.textContent=i+'年'; y.appendChild(o); } for (let i = 1; i <= 12; i++) { const o=document.createElement('option'); o.value=i; o.textContent=i+'月'; m.appendChild(o); } for (let i = 1; i <= 31; i++) { const o=document.createElement('option'); o.value=i; o.textContent=i+'日'; d.appendChild(o); } };
        const setupLotteryWheel = () => { const prizes = ["平果手机", "abibas运动鞋", "汪汪大礼包", "任天唐游戏机", "神秘大奖"]; const wheel = document.getElementById('lottery-wheel'); wheel.innerHTML = ''; const angleStep = 360 / prizes.length; prizes.forEach((prize, index) => { const itemContainer = document.createElement('div'); itemContainer.className = 'prize-item'; const textElement = document.createElement('div'); textElement.className = 'prize-text'; textElement.textContent = prize; const centerAngle = index * angleStep; itemContainer.style.transform = `rotate(${centerAngle}deg)`; let textRotation = -centerAngle; if (centerAngle > 90 && centerAngle < 270) { textRotation += 180; } textElement.style.transform = `rotate(${textRotation}deg)`; itemContainer.appendChild(textElement); wheel.appendChild(itemContainer); }); };
        console.log("9. 初始化函数(populateBirthdaySelects, setupLotteryWheel)定义完毕。");

        populateBirthdaySelects();
        setupLotteryWheel();
        initializePage();
        console.log("10. 最终初始化调用完毕。--- 调试结束：脚本 aparentemente 执行完毕 ---");
    });
</script></body></html>