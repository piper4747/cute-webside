<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>午后の草原散步</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage/dist/av-min.js"></script>

    <style>
        :root { --meadow-green: #A8D8B0; --sky-blue: #BDE0FE; --paper-white: #F8F7F3; --wood-brown: #D4A373; --sunshine-yellow: #FFE898; }
        body, html { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Nunito', 'M PLUS Rounded 1c', sans-serif; background: linear-gradient(to bottom, var(--sky-blue) 0%, #d4eaff 40%, var(--meadow-green) 40%, var(--meadow-green) 100%); color: #333; overflow-x: hidden; }
        header { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 900px; display: flex; justify-content: space-between; align-items: center; padding: 10px 25px; background-color: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 50px; z-index: 100; border: 1px solid rgba(255, 255, 255, 0.2); }
        .logo { font-weight: 700; font-size: 1.2rem; color: var(--wood-brown); }
        .nav-right { display: flex; align-items: center; }
        nav a { text-decoration: none; color: #555; margin-left: 25px; font-weight: 700; transition: color 0.3s; }
        nav a:hover { color: var(--wood-brown); }
        .auth-button { margin-left: 15px; padding: 8px 18px; border: 2px solid var(--wood-brown); border-radius: 20px; background-color: transparent; color: var(--wood-brown); font-weight: 700; cursor: pointer; transition: all 0.3s; }
        .auth-button.login { background-color: var(--wood-brown); color: white; }
        .auth-button:hover { opacity: 0.8; }
        /* 新增：登录后显示的用户信息样式 */
        .user-info { display: none; align-items: center; margin-left: 25px; }
        .user-info img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; border: 2px solid white; }
        .user-info span { font-weight: 700; color: #333; }
        #logout-btn { margin-left: 15px; }
        
        main { padding-top: 100px; }
        .hero-section { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 50vh; text-align: center; position: relative; }
        .hero-section h1 { font-size: 3rem; color: white; text-shadow: 2px 2px 8px rgba(0,0,0,0.2); margin: 0; }
        .content-section { padding: 80px 5%; display: flex; flex-direction: column; align-items: center; }
        .content-card { background-color: var(--paper-white); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); width: 100%; max-width: 800px; border: 1px solid white; }
        .content-card h2 { text-align: center; margin-top: 0; margin-bottom: 30px; color: var(--wood-brown); }
        /* 评论区样式调整，增加头像显示 */
        .comment { display: flex; align-items: flex-start; background-color: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #eee; }
        .comment-avatar { width: 45px; height: 45px; border-radius: 50%; margin-right: 15px; }
        .comment-content { flex: 1; }
        .comment-author { font-weight: 700; color: var(--wood-brown); margin-bottom: 5px; }
        .comment-text { color: #555; }
        .comment-form textarea { width: 100%; height: 80px; padding: 10px; border-radius: 10px; border: 1px solid #ddd; font-family: inherit; box-sizing: border-box; margin-bottom: 10px; resize: vertical; }
        .comment-form button { display: block; margin-left: auto; padding: 10px 25px; border: none; background-color: var(--wood-brown); color: white; border-radius: 20px; font-weight: 700; cursor: pointer; transition: background-color 0.3s; }
        .comment-form button:hover { background-color: #c48f5a; }
        .modal-overlay { display: none; position: fixed; z-index: 200; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { position: fixed; z-index: 201; left: 50%; top: 50%; transform: translate(-50%, -50%); background-color: var(--paper-white); padding: 20px 40px 40px 40px; border-radius: 20px; width: 90%; max-width: 400px; }
        .modal-close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-close-btn:hover { color: #000; }
        .modal-content h2 { margin-bottom: 25px; color: var(--wood-brown); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #555; }
        .form-group input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .form-submit-btn { width: 100%; padding: 12px; border: none; background-color: var(--wood-brown); color: white; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <header>
        <div class="logo">草原だより</div>
        <div class="nav-right">
            <nav>
                <a href="#">首页</a>
                <a href="#">动物伙伴</a>
                <a href="#">图册</a>
            </nav>
            <div id="auth-container">
                <button id="register-btn" class="auth-button">注册</button>
                <button id="login-btn" class="auth-button login">登录</button>
            </div>
            <div id="user-info-container" class="user-info">
                <img id="user-avatar" src="">
                <span id="user-username"></span>
                <button id="logout-btn" class="auth-button">退出</button>
            </div>
        </div>
    </header>

    <main>
        <section class="hero-section"><h1>欢迎来到我们的草原</h1></section>
        <section class="content-section" id="comments">
            <div class="content-card">
                <h2>分享你的想法</h2>
                <div id="comment-list" class="comment-list"></div>
                <hr style="margin: 30px 0; border: 1px solid #eee;">
                <div class="comment-form">
                    <textarea id="comment-input" placeholder="登录后才能发表想法哦..."></textarea>
                    <button id="post-comment-btn">发表评论</button>
                </div>
            </div>
        </section>
    </main>
    
    <div id="register-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close-btn">&times;</span><h2>加入草原</h2><form id="register-form"><div class="form-group"><label for="reg-username">用户名</label><input type="text" id="reg-username" required></div><div class="form-group"><label for="reg-password">密码</label><input type="password" id="reg-password" required></div><div class="form-group"><label for="reg-avatar">头像 (图片链接)</label><input type="text" id="reg-avatar" placeholder="请粘贴有效的图片网址"></div><button type="submit" class="form-submit-btn">立即注册</button></form></div></div>
    <div id="login-modal" class="modal-overlay"><div class="modal-content"><span class="modal-close-btn">&times;</span><h2>回到草原</h2><form id="login-form"><div class="form-group"><label for="login-username">用户名</label><input type="text" id="login-username" required></div><div class="form-group"><label for="login-password">密码</label><input type="password" id="login-password" required></div><button type="submit" class="form-submit-btn">登录</button></form></div></div>


    <script>
        AV.init({
            appId: "ERP3gC0G0Pdrnor7rSpDDIVT-gzGzoHsz",
            appKey: "Gj5IaBMkgKj0uQ4RvejArDXu",
            serverURL: "https://erp3gc0g.lc-cn-n1-shared.com"
        });

        // 获取各种需要操作的页面元素
        const authContainer = document.getElementById('auth-container');
        const userInfoContainer = document.getElementById('user-info-container');
        const userAvatar = document.getElementById('user-avatar');
        const userUsername = document.getElementById('user-username');
        const logoutBtn = document.getElementById('logout-btn');
        const commentInput = document.getElementById('comment-input');
        const postButton = document.getElementById('post-comment-btn');
        const commentList = document.getElementById('comment-list');
        const registerForm = document.getElementById('register-form');
        const loginForm = document.getElementById('login-form');

        // 更新导航栏的用户界面
        function updateNavUI(user) {
            if (user) { // 如果用户已登录
                authContainer.style.display = 'none';
                userInfoContainer.style.display = 'flex';
                userUsername.textContent = user.get('username');
                userAvatar.src = user.get('avatar') || 'https://i.pravatar.cc/150?u=guest'; // 如果没设置头像，给个默认的
                commentInput.placeholder = '留下你的足迹吧...';
            } else { // 如果用户未登录
                authContainer.style.display = 'block';
                userInfoContainer.style.display = 'none';
                commentInput.placeholder = '登录后才能发表想法哦...';
            }
        }

        // --- 注册逻辑 ---
        registerForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const avatar = document.getElementById('reg-avatar').value;
            
            const user = new AV.User();
            user.setUsername(username);
            user.setPassword(password);
            if (avatar) { user.set('avatar', avatar); }
            
            user.signUp().then((loggedInUser) => {
                alert('注册成功并已自动登录!');
                closeModal(document.getElementById('register-modal'));
                updateNavUI(loggedInUser);
                location.reload(); // 刷新页面以更新状态
            }, (error) => {
                alert('注册失败: ' + error.message);
            });
        });

        // --- 登录逻辑 ---
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            AV.User.logIn(username, password).then((loggedInUser) => {
                alert('登录成功!');
                closeModal(document.getElementById('login-modal'));
                updateNavUI(loggedInUser);
                location.reload(); // 刷新页面以更新状态
            }, (error) => {
                alert('登录失败: ' + error.message);
            });
        });
        
        // --- 退出逻辑 ---
        logoutBtn.addEventListener('click', function() {
            AV.User.logOut();
            alert('已退出登录。');
            updateNavUI(null);
            location.reload(); // 刷新页面以更新状态
        });

        // --- 评论区逻辑 ---
        function loadComments() {
            commentList.innerHTML = '正在加载评论...';
            const query = new AV.Query('Comment');
            query.descending('createdAt');
            query.find().then((comments) => {
                commentList.innerHTML = '';
                comments.forEach((comment) => {
                    const content = comment.get('content');
                    const authorName = comment.get('authorName');
                    const authorAvatar = comment.get('authorAvatar') || 'https://i.pravatar.cc/150?u=guest';
                    
                    const commentDiv = document.createElement('div');
                    commentDiv.className = 'comment';
                    commentDiv.innerHTML = `
                        <img src="${authorAvatar}" class="comment-avatar">
                        <div class="comment-content">
                            <div class="comment-author">${authorName}</div>
                            <div class="comment-text">${content}</div>
                        </div>
                    `;
                    commentList.appendChild(commentDiv);
                });
            });
        }

        postButton.addEventListener('click', function() {
            const currentUser = AV.User.current();
            if (!currentUser) {
                alert('请先登录再发表评论哦！');
                return;
            }

            const commentText = commentInput.value;
            if (!commentText.trim()) {
                alert('评论内容不能为空哦！');
                return;
            }
            
            const Comment = AV.Object.extend('Comment');
            const comment = new Comment();
            comment.set('content', commentText);
            // 关键：保存作者的名字和头像链接
            comment.set('authorName', currentUser.get('username'));
            comment.set('authorAvatar', currentUser.get('avatar'));
            
            comment.save().then(() => {
                commentInput.value = '';
                loadComments(); // 重新加载以显示新评论
            });
        });
        
        // --- 页面初始化逻辑 ---
        function initializePage() {
            const currentUser = AV.User.current();
            updateNavUI(currentUser);
            loadComments();
        }
        
        initializePage(); // 页面加载时立即执行初始化

        // --- 弹窗的通用逻辑 ---
        const registerBtn = document.getElementById('register-btn');
        const loginBtn = document.getElementById('login-btn');
        const registerModal = document.getElementById('register-modal');
        const loginModal = document.getElementById('login-modal');
        const closeBtns = document.querySelectorAll('.modal-close-btn');
        function openModal(modal) { modal.style.display = 'block'; }
        function closeModal(modal) { modal.style.display = 'none'; }
        registerBtn.addEventListener('click', () => openModal(registerModal));
        loginBtn.addEventListener('click', () => openModal(loginModal));
        closeBtns.forEach(btn => btn.addEventListener('click', () => {
            closeModal(registerModal);
            closeModal(loginModal);
        }));
        window.addEventListener('click', (event) => {
            if (event.target == registerModal) closeModal(registerModal);
            if (event.target == loginModal) closeModal(loginModal);
        });

    </script>
</body>
</html>
